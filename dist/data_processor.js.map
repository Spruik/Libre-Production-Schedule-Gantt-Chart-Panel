{"version":3,"sources":["../src/data_processor.js"],"names":["restructuredData","rowCols","rows","data","cols","reduce","arr","c","col","text","toLowerCase","push","i","length","row","serise","k","tailorData","influxUrl","utils","influxHost","sort","a","b","production_line","order_data","takeOfKeys","order_dimensions","lines","d","findDistinct","line_data","line","l","split","item","line_dimensions","positioning_dimensions","concat","index","matchIndex","positioning_data","categorisedOrders","categoriseByLineAndDate","promises","lineGroup","dateGroup","_startTime","STkey","dateGroupWithTime","filter","order","findIndex","undefined","dateGroupWithoutTime","wt","startTime","endtime","moment","isBefore","changeover_duration","duration","changeover_startTime","subtract","changeover","copyObject","valueOf","cons","STATE_CHANGEOVER","o","lineDefaultStartTime","getLineStartTime","currentStartTime","_endTime","add","writeLine","mergeKeyVal","post","Promise","all","then","res","chartCtrl","refreshDashb","catch","e","alert","_order_data","_order_dimensions","forEach","product_id_api","dimensions","key","map","Object","values","obj","result","elem","objdata","dates","order_date","Array","from","Set","dateIndex","array","indexOf","order_id","product_id","compl_qty","machine_state","getRid","status","product_desc","planned_changeover_time","order_qty","endTime","planned_rate","x","join","getColor","color","STATE_PLAN","STATE_READY","STATE_FLAG","STATE_PAUSE","STATE_COMPLETE","STATE_CLOSE","STATE_START","getData","mergeKeyArrayVal"],"mappings":"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","file":"data_processor.js","sourcesContent":["import * as utils from './utils';\nimport * as cons from './constans';\nimport moment from 'moment';\nimport * as chartCtrl from './chart_ctrl';\n\nlet _order_data;\nlet _order_dimensions;\n\n/**\n * Expecting columns names, and rows values\n * Return {col-1 : value-1, col-2 : value-2 .....}\n * @param {*} rowCols \n * @param {*} rows \n */\nexport function restructuredData(rowCols, rows) {\n\tlet data = [];\n\tlet cols = rowCols.reduce((arr, c) => {\n\t\tconst col = c.text.toLowerCase();\n\t\tarr.push(col);\n\t\treturn arr;\n\t}, []);\n\tfor (let i = 0; i < rows.length; i++) {\n\t\tconst row = rows[i];\n\t\tlet serise = {};\n\t\tfor (let k = 0; k < cols.length; k++) {\n\t\t\tconst col = cols[k];\n\t\t\tserise[col] = row[k];\n\t\t}\n\t\tdata.push(serise);\n\t}\n\n\tif (data.length === 0) {\n\t\treturn [];\n\t}\n\n\treturn tailorData(data, rowCols);\n}\n\nfunction tailorData(data, rowCols) {\n\t//url for writing influxdb data\n\tconst influxUrl = utils.influxHost + 'write?db=smart_factory';\n\n\t//sort\n\tif (data.length > 1) {\n\t\tdata = data.sort(\n\t\t\t(a, b) => (a.production_line > b.production_line ? -1 : a.production_line < b.production_line ? 1 : 0)\n\t\t);\n\t}\n\n\t//make order_data and its dimensions\n\tlet order_data = takeOfKeys(data);\n\n\tlet order_dimensions = rowCols.reduce((arr, col) => {\n\t\tarr.push(col.text.toLowerCase());\n\t\treturn arr;\n\t}, []);\n\n\t//find distinct lines\n\tlet lines = data.reduce((arr, d) => {\n\t\tarr.push(d.production_line);\n\t\treturn arr;\n\t}, []);\n\tlines = utils.findDistinct(lines);\n\n\t//make line_data to match the dimension, which is expected by the chart option data\n\tlet line_data = [];\n\tfor (let i = 0; i < lines.length; i++) {\n\t\tconst line = lines[i];\n\t\tconst l = line.split(' | ');\n\t\tconst item = [ l[0] + ' | ' + l[1], l[2], i, line ];\n\t\tline_data.push(item);\n\t}\n\n\tlet line_dimensions = [ 'SiteArea', 'Line', 'Index', 'ProductionLine' ];\n\n\t//add elems to the dimension, which are expected by the option\n\tconst positioning_dimensions = [ 'index', 'startTime', 'endTime' ];\n\torder_dimensions = positioning_dimensions.concat(order_dimensions);\n\n\t//add elems to the order_data to match the dimension\n\tfor (let i = 0; i < order_data.length; i++) {\n\t\tconst d = data[i];\n\t\tconst index = matchIndex(d.production_line, line_data);\n\t\tdata[i]['index'] = index;\n\t\tconst positioning_data = [ index, 0, 0 ];\n\t\torder_data[i] = positioning_data.concat(order_data[i]);\n\t}\n\n\t//categorise the order_data, group by line, and in each lineGroup, group by date\n\tconst categorisedOrders = categoriseByLineAndDate(order_data, 'array', data);\n\t//console.log(categorisedOrders)\n\tlet promises = [];\n\tfor (let i = 0; i < categorisedOrders.length; i++) {\n\t\tconst lineGroup = categorisedOrders[i];\n\t\tfor (let c = 0; c < lineGroup.length; c++) {\n\t\t\tconst dateGroup = lineGroup[c];\n\t\t\tlet _startTime = 0;\n\n\t\t\t//filter out two groups, one is with startTime initalised, one is not.\n\t\t\tconst STkey = 'scheduled_start_datetime';\n\t\t\tconst dateGroupWithTime = dateGroup.filter(\n\t\t\t\t(order) =>\n\t\t\t\t\torder[findIndex(STkey, order_dimensions)] !== null &&\n\t\t\t\t\torder[findIndex(STkey, order_dimensions)] !== undefined\n\t\t\t);\n\t\t\tconst dateGroupWithoutTime = dateGroup.filter(\n\t\t\t\t(order) =>\n\t\t\t\t\torder[findIndex(STkey, order_dimensions)] === null ||\n\t\t\t\t\torder[findIndex(STkey, order_dimensions)] === undefined\n\t\t\t);\n\n\t\t\t//loop thro the date group containing orders that are with time\n\t\t\tfor (let wt = 0; wt < dateGroupWithTime.length; wt++) {\n\t\t\t\tconst order = dateGroupWithTime[wt];\n\t\t\t\tconst startTime = order[findIndex(STkey, order_dimensions)];\n\t\t\t\tconst endtime = order[findIndex('scheduled_end_datetime', order_dimensions)];\n\n\t\t\t\tif (_startTime === 0) {\n\t\t\t\t\t_startTime = moment(endtime);\n\t\t\t\t} else {\n\t\t\t\t\t//start time has been initialised, check if the end time is after the initialised start time\n\t\t\t\t\tif (_startTime.isBefore(moment(endtime))) {\n\t\t\t\t\t\t//if yes, update the starttime again\n\t\t\t\t\t\t_startTime = moment(endtime);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t//update order's startTime and endTime\n\t\t\t\torder[findIndex('startTime', order_dimensions)] = startTime;\n\t\t\t\torder[findIndex('endTime', order_dimensions)] = endtime;\n\n\t\t\t\tlet changeover_duration = order[findIndex('planned_changeover_time', order_dimensions)];\n\t\t\t\tif (changeover_duration !== '0:00:00') {\n\t\t\t\t\t//if the order has changeover time\n\t\t\t\t\tchangeover_duration = moment.duration(changeover_duration);\n\t\t\t\t\tconst changeover_startTime = moment(startTime).subtract(changeover_duration);\n\t\t\t\t\tlet changeover = utils.copyObject(order);\n\t\t\t\t\tchangeover[findIndex('endTime', order_dimensions)] = startTime; // changeover's end time = main order's start time\n\t\t\t\t\tchangeover[findIndex('startTime', order_dimensions)] = changeover_startTime.valueOf(); // changeover's start time = it's end time - it's changeover time\n\t\t\t\t\tchangeover[findIndex('status', order_dimensions)] = cons.STATE_CHANGEOVER; // set statuts to be changeover\n\t\t\t\t\torder_data.push(changeover);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t//console.log(dateGroupWithoutTime)\n\n\t\t\t//loop thro the date group containing orders that are with NO time\n\t\t\tfor (let o = 0; o < dateGroupWithoutTime.length; o++) {\n\t\t\t\tconst order = dateGroupWithoutTime[o];\n\t\t\t\tlet lineDefaultStartTime = utils.getLineStartTime(\n\t\t\t\t\torder[findIndex('production_line', order_dimensions)]\n\t\t\t\t);\n\t\t\t\t//if there is no startTime, init it with the order_date and lineDefaultStartTime\n\t\t\t\tif (_startTime === 0) {\n\t\t\t\t\t_startTime = order[findIndex('order_date', order_dimensions)] + ' ' + lineDefaultStartTime;\n\t\t\t\t\t_startTime = moment(_startTime, 'YYYY-MM-DD H:mm:ss');\n\t\t\t\t}\n\n\t\t\t\t//get startTime, then calc the order's duration based on qty and rate, then calc the endTime\n\t\t\t\tlet currentStartTime = _startTime.valueOf();\n\t\t\t\tlet duration =\n\t\t\t\t\torder[findIndex('order_qty', order_dimensions)] /\n\t\t\t\t\t(order[findIndex('planned_rate', order_dimensions)] * 60);\n\t\t\t\tlet _endTime = _startTime.add(duration, 'hours');\n\n\t\t\t\t//handle changeover\n\t\t\t\tlet changeover_duration = order[findIndex('planned_changeover_time', order_dimensions)];\n\t\t\t\tif (changeover_duration !== '0:00:00') {\n\t\t\t\t\t//if the order has changeover time\n\t\t\t\t\tchangeover_duration = moment.duration(changeover_duration);\n\t\t\t\t\tlet changeover = utils.copyObject(order);\n\t\t\t\t\t// console.log('change_in', changeover)\n\t\t\t\t\t// console.log('change_d_in', order_dimensions)\n\t\t\t\t\tchangeover[findIndex('startTime', order_dimensions)] = currentStartTime; // changeover's start time = current start time\n\t\t\t\t\tchangeover[findIndex('endTime', order_dimensions)] = moment(currentStartTime)\n\t\t\t\t\t\t.add(changeover_duration)\n\t\t\t\t\t\t.valueOf(); // changeover's end time = main order's start time\n\t\t\t\t\tchangeover[findIndex('status', order_dimensions)] = cons.STATE_CHANGEOVER; // set statuts to be changeover\n\n\t\t\t\t\torder_data.push(changeover);\n\n\t\t\t\t\t//update the order's startTime and endTime\n\t\t\t\t\torder[findIndex('startTime', order_dimensions)] = moment(currentStartTime)\n\t\t\t\t\t\t.add(changeover_duration)\n\t\t\t\t\t\t.valueOf();\n\t\t\t\t\torder[findIndex('endTime', order_dimensions)] = _endTime.add(changeover_duration).valueOf();\n\t\t\t\t} else {\n\t\t\t\t\t//update the order's startTime and endTime\n\t\t\t\t\torder[findIndex('startTime', order_dimensions)] = currentStartTime;\n\t\t\t\t\torder[findIndex('endTime', order_dimensions)] = _endTime.valueOf();\n\t\t\t\t}\n\n\t\t\t\t//update each order to the database\n\t\t\t\tconst line = writeLine(utils.mergeKeyVal(order, order_dimensions));\n\t\t\t\tpromises.push(utils.post(influxUrl, line));\n\t\t\t}\n\t\t}\n\t}\n\n\tif (promises.length > 0) {\n\t\t//do nothing if requests are successful, popup the error if failed.\n\t\tPromise.all(promises)\n\t\t\t.then((res) => {\n\t\t\t\tchartCtrl.refreshDashb();\n\t\t\t})\n\t\t\t.catch((e) => {\n\t\t\t\tutils.alert('error', 'Influxdb Error', 'An error occurred while updating data : ' + e);\n\t\t\t});\n\t}\n\n\t//set order data and its dimension global because it will be required later from other files\n\t_order_data = order_data;\n\t_order_dimensions = order_dimensions;\n\n\t// Echart automatically convert number String to Int, so need to add some extra non-num String to avoid this\n\t// Will need to String.replace('###', '') when use it\n\torder_data.forEach((e) => {\n\t\tconst product_id_api = e[findIndex('product_id', order_dimensions)] + '###';\n\t\te.push(product_id_api);\n\t});\n\torder_dimensions.push('product_id_api');\n\n\t//return the expect option data\n\treturn {\n\t\torder: { data: order_data, dimensions: order_dimensions },\n\t\tline: { data: line_data, dimensions: line_dimensions }\n\t};\n}\n\nfunction matchIndex(key, lines) {\n\tfor (let i = 0; i < lines.length; i++) {\n\t\tconst line = lines[i];\n\t\tif (key === line[3]) {\n\t\t\treturn line[2];\n\t\t}\n\t}\n\treturn -1;\n}\n\nfunction takeOfKeys(data) {\n\treturn data.map(Object.values);\n}\n\n/**\n * Expecting an array of arrays, categorise the inner arrays by line\n */\nfunction categoriseByLineAndDate(data, key, obj) {\n\tlet result = [];\n\n\tfor (let i = 0; i < data.length; i++) {\n\t\tconst elem = data[i];\n\t\tconst objdata = obj[i];\n\n\t\tlet dates = obj.filter((d) => d.production_line === objdata.production_line).map((d) => d.order_date);\n\t\tdates = Array.from(new Set(dates));\n\t\tconst dateIndex = findIndex(objdata.order_date, dates);\n\n\t\tif (result[objdata.index]) {\n\t\t\tif (result[objdata.index][dateIndex]) {\n\t\t\t\tresult[objdata.index][dateIndex].push(elem);\n\t\t\t} else {\n\t\t\t\tresult[objdata.index].push([]);\n\t\t\t\tresult[objdata.index][dateIndex].push(elem);\n\t\t\t}\n\t\t} else {\n\t\t\tresult.push([]);\n\t\t\tif (result[objdata.index][dateIndex]) {\n\t\t\t\tresult[objdata.index][dateIndex].push(elem);\n\t\t\t} else {\n\t\t\t\tresult[objdata.index].push([]);\n\t\t\t\tresult[objdata.index][dateIndex].push(elem);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn result;\n}\n\nexport function findIndex(key, array) {\n\treturn array.indexOf(key);\n}\n\nfunction writeLine(data) {\n\t//For influxdb tag keys, must add a forward slash \\ before each space\n\t// let product_desc = data.product_desc.split(' ').join('\\\\ ')\n\n\tlet line = `OrderPerformance,order_id=${data.order_id},product_id=${data.product_id} `;\n\n\tif (data.compl_qty !== null && data.compl_qty !== undefined) {\n\t\tline += 'compl_qty=' + data.compl_qty + ',';\n\t}\n\tif (data.machine_state !== null && data.machine_state !== undefined) {\n\t\tline += 'machine_state=\"' + getRid(data.machine_state) + '\"' + ',';\n\t}\n\n\tline += 'order_state=\"' + getRid(data.status) + '\"' + ',';\n\tline += 'product_desc=\"' + getRid(data.product_desc) + '\"' + ',';\n\tline += 'order_date=\"' + data.order_date + '\"' + ',';\n\tline += 'production_line=\"' + getRid(data.production_line) + '\"' + ',';\n\tline += 'planned_changeover_time=\"' + data.planned_changeover_time + '\"' + ',';\n\tline += 'order_qty=' + data.order_qty + ',';\n\tline += 'scheduled_end_datetime=' + data.endTime + ',';\n\tline += 'scheduled_start_datetime=' + data.startTime + ',';\n\tline += 'setpoint_rate=' + 0 + ',';\n\tline += 'planned_rate=' + data.planned_rate;\n\n\treturn line;\n}\n\nfunction getRid(x) {\n\treturn x.split('\"').join('\\\\\"');\n}\n\nexport function getColor(status) {\n\tlet color;\n\tswitch (status.toLowerCase()) {\n\t\tcase cons.STATE_CHANGEOVER:\n\t\t\tcolor = '#c9c52a';\n\t\t\tbreak;\n\t\tcase cons.STATE_PLAN:\n\t\t\tcolor = '#c9c9c9';\n\t\t\tbreak;\n\t\tcase cons.STATE_READY:\n\t\t\tcolor = '#CCFFAF';\n\t\t\tbreak;\n\t\tcase cons.STATE_FLAG:\n\t\t\tcolor = '#FFFB85';\n\t\t\tbreak;\n\t\tcase cons.STATE_PAUSE:\n\t\t\tcolor = '#E8B20C';\n\t\t\tbreak;\n\t\tcase cons.STATE_COMPLETE:\n\t\t\tcolor = '#70C6FF';\n\t\t\tbreak;\n\t\tcase cons.STATE_CLOSE:\n\t\t\tcolor = '#FF7773';\n\t\t\tbreak;\n\t\tcase cons.STATE_START:\n\t\t\tcolor = '#91F449';\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tcolor = '#fff';\n\t\t\tbreak;\n\t}\n\treturn color;\n}\n\nexport function getData() {\n\treturn utils\n\t\t.mergeKeyArrayVal(_order_data, _order_dimensions)\n\t\t.filter((order) => order.status.toLowerCase() !== cons.STATE_CHANGEOVER);\n}\n"]}
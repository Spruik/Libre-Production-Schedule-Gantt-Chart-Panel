{"version":3,"sources":["../src/insertion_actions_ctrl.js"],"names":["showActions","targetOrder","_isInsertingBefore","_targetOrder","utils","showModal","removeListeners","addListeners","$","document","off","on","e","target","id","showOrderForm","getProducts","callback","_tryCatchCounter","tryInitialisingForm","removeListenersForOrderForm","addListenersForOrderForm","setTimeout","initialiseForm","closeForm","alert","instant_search","enableInstantSearch","_products","timepicker","showMeridian","showSeconds","maxHours","minuteStep","secondStep","defaultTime","icons","up","down","prefill","time","moment","startTime","endTime","format","val","production_line","data","serializeArray","submitOrder","updateDuration","value","allData","dp","getData","changeover","qty","rate","order_duration","Number","parseFloat","toFixed","calcStartTime","add","duration","valueOf","inputValues","orderId","orderQty","productionLine","product","date","order_date","plannedRate","isValueValid","insertOrder","ordersWithSameLine","filter","order","ordersBeingAffected","changeover_dur","subtract","insertOrderChangeover","totalDuration","diff","isLineHavingSpareTimeForTheDay","promises","initState","orderActions","getOrderStates","x","is_init_state","state","line","influx","writeLineForCreate","push","post","writeUrl","i","length","writeLineForTimeUpdate","Promise","all","then","res","chart","refreshDashboard","catch","planned_changeover_time","dateRegExp","RegExp","prodList","reduce","arr","p","str","product_desc","indexOf","test","ordersAffected","insertingOrderDuration","targetOrderEndTime","maxEndTime","all_end_times","map","Math","max","targetDay","nextDay","nextDayStartTime","getLineStartTime","isSameOrBefore","durationHrs","momentDuration","durationText","getDurationText","month","get","days","hrs","mins","text","productsUrl","postgRestHost","trigger"],"mappings":"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","file":"insertion_actions_ctrl.js","sourcesContent":["import * as utils from './utils';\nimport * as influx from './influx_helper';\nimport * as dp from './data_processor';\nimport * as instant_search from './instant_search_ctrl';\nimport * as orderActions from './order_actions_ctrl';\nimport moment from 'moment';\nimport * as chart from './chart_option';\n\nlet _isInsertingBefore;\nlet _targetOrder;\nlet _products;\nlet _tryCatchCounter = 1;\n\nconst closeForm = () => $('a#product-schedule-gantt-chart-order-form-close-btn').trigger('click');\n\n/**\n * Show insert actions entry point, will be showed when the user clicked 'Insert' in the order actions form\n * Set the target order global --> show insert actions form (allowing user to choose insert left or right) -\n * --> remove/add listeners\n * @param {*} targetOrder \n */\nexport function showActions(targetOrder) {\n\t_isInsertingBefore = false;\n\t_targetOrder = targetOrder;\n\tutils.showModal('insert_actions.html', {});\n\n\t//set listeners\n\tremoveListeners();\n\taddListeners();\n}\n\nfunction removeListeners() {\n\t$(document).off('click', 'input[type=\"radio\"][name=\"product-schedule-gantt-chart-insertion-actions-radio\"]');\n}\n\n/**\n * Add listener to check user click\n * If click left (before), set insertion status (_isInsertingBefore) to TRUE and then show order form\n * If click right (after), set insertion status (_isInsertingBefore) to FALSE and then show order form\n */\nfunction addListeners() {\n\t$(document).on('click', 'input[type=\"radio\"][name=\"product-schedule-gantt-chart-insertion-actions-radio\"]', (e) => {\n\t\tif (e.target.id === 'before') {\n\t\t\t_isInsertingBefore = true;\n\t\t\tshowOrderForm();\n\t\t} else if (e.target.id === 'after') {\n\t\t\t_isInsertingBefore = false;\n\t\t\tshowOrderForm();\n\t\t}\n\t});\n}\n\n/**\n * Show form entry point, will be showed when the user clicked insert left or right\n * Get data --> Show Form --> Initialse special functions --> remove/add listeners\n */\nfunction showOrderForm() {\n\t//get products data from postgres database\n\tgetProducts(callback);\n\n\t//getting data successful\n\tfunction callback() {\n\t\t//show the modal form\n\t\tutils.showModal('order_form.html', {});\n\n\t\t//try initialize the form\n\t\t_tryCatchCounter = 1;\n\t\ttryInitialisingForm();\n\n\t\t//set listeners\n\t\tremoveListenersForOrderForm();\n\t\taddListenersForOrderForm();\n\t}\n}\n\n/**\n * Try initialise the form, if failed, wait for 200 milsec and then re-init the form again\n * If failed over 15 times, stop initialising and show error to the user\n */\nfunction tryInitialisingForm() {\n\tsetTimeout(() => {\n\t\ttry {\n\t\t\tinitialiseForm();\n\t\t} catch (e) {\n\t\t\tif (_tryCatchCounter < 15) {\n\t\t\t\t//maximunm re-init the form over 15 times\n\t\t\t\ttryInitialisingForm();\n\t\t\t\t_tryCatchCounter++;\n\t\t\t} else {\n\t\t\t\tcloseForm();\n\t\t\t\tutils.alert('error', 'Error', 'Form initialisation failed, please try agian : ' + e);\n\t\t\t}\n\t\t}\n\t}, 200);\n}\n\n/**\n * Initialise the instant search function for product field and equipment field\n * Initialise the timepicker for the changeover field\n */\nfunction initialiseForm() {\n\t//init the instant search function\n\tinstant_search.enableInstantSearch(_products);\n\n\t//init timepicker\n\t$('#changeover-minutes-picker').timepicker({\n\t\tshowMeridian: false,\n\t\tshowSeconds: true,\n\t\tmaxHours: 100,\n\t\tminuteStep: 1,\n\t\tsecondStep: 1,\n\t\tdefaultTime: '00:00:00',\n\t\ticons: {\n\t\t\tup: 'fa fa-chevron-up',\n\t\t\tdown: 'fa fa-chevron-down'\n\t\t}\n\t});\n\n\t//prefill date field and production line\n\tprefill();\n}\n\n/**\n * Prefill the datepicker because it is inserting, the date is based on the target order's startime or endtime\n * Prefill the Production Line field where it equals to the targeted order's line\n * Current order's date = target order's start time if it is inserting before\n * Current order's date = target order's end time if it is inserting after\n */\nfunction prefill() {\n\tconst time = moment(_isInsertingBefore ? _targetOrder.startTime : _targetOrder.endTime).format('YYYY-MM-DD');\n\t$('input.prod-sche-gt-chart-datalist-input#datepicker').val(time);\n\t$('input.prod-sche-gt-chart-datalist-input#datalist-input-production-line').val(_targetOrder.production_line);\n}\n\nfunction removeListenersForOrderForm() {\n\t$(document).off('click', 'button#product-schedule-gantt-chart-order-form-submitBtn');\n\t$(document).off('input', 'input#planned-rate, input#order-qty');\n}\n\nfunction addListenersForOrderForm() {\n\t$(document).on('click', 'button#product-schedule-gantt-chart-order-form-submitBtn', (e) => {\n\t\tlet data = $('form#product-schedule-gantt-chart-order-form').serializeArray();\n\t\tsubmitOrder(data);\n\t});\n\n\t$(document).on('input', 'input#planned-rate, input#order-qty', (e) => {\n\t\tlet data = $('form#product-schedule-gantt-chart-order-form').serializeArray();\n\t\tupdateDuration(data[1].value, data[5].value);\n\t});\n}\n\nfunction submitOrder(data) {\n\t//locate the line where the user is trying to insert the new order, which is for further filtering uses\n\tconst allData = dp.getData();\n\n\tconst changeover = data[7].value;\n\tconst qty = data[1].value;\n\tconst rate = data[5].value;\n\tconst order_duration = Number(parseFloat(qty).toFixed(2)) / Number((parseFloat(rate) * 60).toFixed(2));\n\tconst startTime = moment(_isInsertingBefore ? calcStartTime(_targetOrder) : _targetOrder.endTime)\n\t\t.add(moment.duration(changeover))\n\t\t.valueOf();\n\tconst endTime = moment(_isInsertingBefore ? calcStartTime(_targetOrder) : _targetOrder.endTime)\n\t\t.add(moment.duration(changeover))\n\t\t.add(order_duration, 'hours')\n\t\t.valueOf();\n\n\tconst inputValues = {\n\t\torderId: data[0].value,\n\t\torderQty: qty,\n\t\tproductionLine: data[2].value,\n\t\tproduct: data[3].value,\n\t\tdate: _targetOrder.order_date,\n\t\tplannedRate: rate,\n\t\tduration: data[6].value,\n\t\tchangeover: changeover,\n\t\tstartTime: startTime,\n\t\tendTime: endTime\n\t};\n\n\tif (isValueValid(inputValues)) {\n\t\tinsertOrder(inputValues, allData);\n\t}\n}\n\nfunction insertOrder(inputValues, allData) {\n\t//Firstly, find all data to look for orders in the same line to see if there is other order affected by this insertion\n\tconst ordersWithSameLine = allData.filter((order) => order.production_line === _targetOrder.production_line);\n\n\tconst ordersBeingAffected = ordersWithSameLine.filter((order) => {\n\t\tlet startTime = moment(inputValues.startTime);\n\t\tlet changeover_dur = moment.duration(inputValues.changeover);\n\t\treturn order.startTime >= startTime.subtract(changeover_dur).valueOf() && order.order_date === inputValues.date;\n\t});\n\n\t//calculate the total duration that the inserting order is taking, and then each affected order will be adding up with this total duarion later\n\tconst insertOrderChangeover = moment.duration(inputValues.changeover);\n\tconst totalDuration = moment.duration(moment(inputValues.endTime).diff(moment(inputValues.startTime)));\n\ttotalDuration.add(insertOrderChangeover);\n\n\tif (!isLineHavingSpareTimeForTheDay(ordersBeingAffected, totalDuration, _targetOrder.endTime)) {\n\t\tutils.alert('warning', 'Warning', \"There is no spare space for this order to fit in this date's schedule\");\n\t\treturn;\n\t}\n\n\t//promises for later requests\n\tlet promises = [];\n\n\t// get initState from the database state model config table\n\tconst initState = orderActions.getOrderStates().filter((x) => x.is_init_state);\n\tif (!initState[0] || !initState[0].state) {\n\t\tutils.alert(\n\t\t\t'error',\n\t\t\t'Error',\n\t\t\t`Initial State NOT Found from the state model config table, please specify an Initial State before creating order`\n\t\t);\n\t\treturn;\n\t}\n\n\t//update the inserting order first\n\tconst line = influx.writeLineForCreate(inputValues, initState[0].state);\n\tpromises.push(utils.post(influx.writeUrl, line));\n\n\t//loop thro the ordersBeingAffected to update all orders being affected\n\tfor (let i = 0; i < ordersBeingAffected.length; i++) {\n\t\tconst order = ordersBeingAffected[i];\n\t\tconst line = influx.writeLineForTimeUpdate(order, totalDuration, 'add');\n\t\tpromises.push(utils.post(influx.writeUrl, line));\n\t}\n\n\t//handle requests\n\tPromise.all(promises)\n\t\t.then((res) => {\n\t\t\t//successful\n\t\t\tcloseForm();\n\t\t\tutils.alert('success', 'Successful', 'Order has been successfully inserted');\n\t\t\tchart.refreshDashboard();\n\t\t})\n\t\t.catch((e) => {\n\t\t\t//error\n\t\t\tutils.alert('error', 'Error', 'An error occurred when inserting the order : ' + e);\n\t\t});\n}\n\n/**\n * Add up order's start time and its changeover time to see it's real start time\n * @param {*} order \n */\nfunction calcStartTime(order) {\n\treturn moment(order.startTime).subtract(moment.duration(order.planned_changeover_time)).valueOf();\n}\n\n/**\n * Expect the user inputs\n * Check if the user inputs are valid\n * Stop and prompt error if the inputs are not valid\n * @param {*} data \n */\nfunction isValueValid(data) {\n\tconst dateRegExp = new RegExp(\n\t\t'^[0-9]{4}-(((0[13578]|(10|12))-(0[1-9]|[1-2][0-9]|3[0-1]))|(02-(0[1-9]|[1-2][0-9]))|((0[469]|11)-(0[1-9]|[1-2][0-9]|30)))$'\n\t);\n\tconst prodList = _products.reduce((arr, p) => {\n\t\tconst str = p.id + ' | ' + p.product_desc;\n\t\tarr.push(str);\n\t\treturn arr;\n\t}, []);\n\n\tif (data.orderId === '') {\n\t\tutils.alert('warning', 'Warning', 'Order Number Empty, please enter the Order Number');\n\t\treturn false;\n\t}\n\n\tif (data.orderQty === '') {\n\t\tutils.alert('warning', 'Warning', 'Order Quantity Empty, please enter the Order Quantity');\n\t\treturn false;\n\t}\n\n\tif (data.product === '') {\n\t\tutils.alert('warning', 'Warning', 'Product Empty, please enter the Product');\n\t\treturn false;\n\t} else {\n\t\tif (prodList.indexOf(data.product) === -1) {\n\t\t\tutils.alert('warning', 'Warning', 'Product Not Exist, please select a Product from the Product List');\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tif (!dateRegExp.test(data.date)) {\n\t\tutils.alert(\n\t\t\t'warning',\n\t\t\t'Warning',\n\t\t\t'Scheduled Start Date Empty or Invalid Date Format, please choose a date from the date picker'\n\t\t);\n\t\treturn false;\n\t}\n\n\tif (data.plannedRate === '') {\n\t\tutils.alert('warning', 'Warning', 'Planned Rate Empty, please enter the Planned Rate');\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\n/**\n * Expecting the array of all orders that are affected @param {*} ordersAffected , \n * and the moment object of the totoal duration\n * @param {*} insertingOrderDuration  (including order duration time and changeover duration time)\n * \n * Return a boolean to tell if an order can be made.\n * \n * If, after adding up with the inserting order's duration, the last affected order's end time exceeds the next day's start time, return false\n */\nfunction isLineHavingSpareTimeForTheDay(ordersAffected, insertingOrderDuration, targetOrderEndTime) {\n\t//find the max value of affected orders' end time\n\tlet maxEndTime;\n\tif (ordersAffected.length !== 0) {\n\t\tconst all_end_times = ordersAffected.map((order) => order.endTime);\n\t\tmaxEndTime = moment(Math.max(...all_end_times));\n\t} else {\n\t\t//if there is no affected orders, the target order's endtime is the maxtime\n\t\tmaxEndTime = moment(targetOrderEndTime);\n\t}\n\t//get the target day's order date in order to calculate the next day\n\tconst targetDay = moment(_targetOrder.order_date, 'YYYY-MM-DD');\n\tconst nextDay = targetDay.add(1, 'days').format('YYYY-MM-DD');\n\n\t//max time add inserting order's total duration\n\tmaxEndTime.add(insertingOrderDuration);\n\n\t//use next day to make up next day's start time\n\tconst nextDayStartTime = moment(\n\t\tnextDay + ' ' + utils.getLineStartTime(_targetOrder.production_line),\n\t\t'YYYY-MM-DD H:mm:ss'\n\t);\n\n\t//if after adding the max time with the inserting order's total duration, max time is greater than next day's start time, return false\n\treturn maxEndTime.isSameOrBefore(nextDayStartTime);\n}\n\n/**\n * Use the qty and rate that are passed in to dynamically update the duration field\n * @param {*} qty \n * @param {*} rate \n */\nfunction updateDuration(qty, rate) {\n\tif (qty !== '' && rate !== '') {\n\t\tlet durationHrs = Number(parseFloat(qty).toFixed(2)) / Number((parseFloat(rate) * 60).toFixed(2));\n\t\tlet momentDuration = moment.duration(durationHrs, 'hours');\n\n\t\tlet durationText = getDurationText(momentDuration);\n\n\t\t$('input.prod-sche-gt-chart-datalist-input#duration').val(durationText);\n\t} else {\n\t\t$('input.prod-sche-gt-chart-datalist-input#duration').val('');\n\t}\n}\n\nfunction getDurationText(momentDuration) {\n\tlet month = momentDuration.get('month');\n\tlet days = momentDuration.get('d');\n\tlet hrs = momentDuration.get('h');\n\tlet mins = momentDuration.get('minute');\n\tlet text = 'under 1 minute';\n\n\tif (month > 0) {\n\t\treturn 'Over a month!';\n\t}\n\n\tif (days !== 0) {\n\t\thrs += days * 24;\n\t}\n\n\tif (hrs !== 0 && mins !== 0) {\n\t\ttext = hrs + ' hour(s) & ' + mins + ' minute(s)';\n\t} else if (hrs !== 0 && mins === 0) {\n\t\ttext = hrs + ' hour(s)';\n\t} else if (hrs === 0 && mins !== 0) {\n\t\ttext = mins + ' minute(s)';\n\t}\n\n\treturn text;\n}\n\n/**\n * Retrieve product data and equipment data from Postgres\n * Set the retrieved data global\n * Call the callback function passed in when all is successful\n * Alert error when anyone of them has failed\n * @param {*} callback \n */\nfunction getProducts(callback) {\n\tlet productsUrl = utils.postgRestHost + 'product';\n\tutils\n\t\t.get(productsUrl)\n\t\t.then((res) => {\n\t\t\t_products = res;\n\t\t\tcallback();\n\t\t})\n\t\t.catch((e) => {\n\t\t\tutils.alert('error', 'Error', 'An error occurred while fetching data from the postgresql : ' + e);\n\t\t});\n}\n"]}
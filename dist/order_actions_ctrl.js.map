{"version":3,"sources":["../src/order_actions_ctrl.js"],"names":["showOrderActions","order","_order","status","utils","alert","rowData","order_state","showModal","removeListeners","addListeners","$","document","off","on","e","target","id","insertOrder","editOrder","closeForm","updateOrderStatus","insert_actions","showActions","edit_actions","line","influx","writeLineForUpdate","deleteCurrentAndUpdateAffectOrders","post","writeUrl","then","chart","refreshDashboard","catch","promises","allData","dp","getData","affectedOrders","filter","startTime","endTime","production_line","order_date","deletingOrderDurationHour","moment","duration","order_qty","planned_rate","deletingOrderChangeover","planned_changeover_time","deletingOrderTotalDur","add","forEach","writeLineForTimeUpdate","push","Promise","all","trigger"],"mappings":"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","file":"order_actions_ctrl.js","sourcesContent":["import * as utils from './utils'\nimport * as influx from './influx_helper'\nimport * as insert_actions from './insertion_actions_ctrl'\nimport * as edit_actions from './editing_actions_ctrl'\nimport * as dp from './data_processor'\nimport moment from 'moment'\nimport * as chart from './chart_option'\n\nlet _order\nconst closeForm = () => $('a#product-schedule-gantt-chart-order-actions-close-btn').trigger('click')\n\nexport function showOrderActions(order){\n  //set the order passed in global\n  _order = order\n\n  //check if the order is available for editing, only 'planned' and 'ready' can be edited by scheduler\n  if (order.status !== 'Planned' && order.status !== 'Ready') {\n    utils.alert('warning', 'Warning', 'This order is ' + rowData.order_state + ' and is no longer available for editing')\n    return\n  }\n\n  //pop up the actions form\n  utils.showModal('order_actions.html', {})\n\n  //set listeners\n  removeListeners()\n  addListeners()\n}\n\nfunction removeListeners(){\n  $(document).off('click', 'input[type=\"radio\"][name=\"product-schedule-gantt-chart-order-actions-radio\"]')\n}\n\nfunction addListeners(){\n  $(document).on('click', 'input[type=\"radio\"][name=\"product-schedule-gantt-chart-order-actions-radio\"]', e => {\n    if (e.target.id === 'insert') {\n      insertOrder()\n    }else if (e.target.id === 'edit') {\n      editOrder()\n    }else if (e.target.id === 'release') {\n      if (_order.status === 'Ready') {\n        utils.alert('warning', 'Warning', 'Order has already been released')\n        closeForm()\n      }else{\n        updateOrderStatus('Ready')\n      }\n    }else if (e.target.id === 'delete') {\n      updateOrderStatus('Deleted')\n    }\n  })\n}\n\nfunction insertOrder(){\n  insert_actions.showActions(_order)\n}\n\nfunction editOrder(){\n  edit_actions.showActions(_order)\n}\n\nfunction updateOrderStatus(status){\n  const line = influx.writeLineForUpdate(status, _order)\n  if (status === 'Deleted') {\n    deleteCurrentAndUpdateAffectOrders(line)\n  }else {\n    utils.post(influx.writeUrl, line).then(res => {\n      utils.alert('success', 'Success', 'Order has been marked as ' + status)\n      closeForm()\n      chart.refreshDashboard()\n    }).catch(e => {\n      utils.alert('error', 'Database Error', 'An error occurred while updating the order : ' + e)\n      closeForm()\n    })\n  }\n}\n\n\nfunction deleteCurrentAndUpdateAffectOrders(line){\n  //create promises array and put the 'delete current order request' into it first\n  let promises = [utils.post(influx.writeUrl, line)]\n\n  //get all orders data for further filtering\n  const allData = dp.getData()\n\n  //filter affected orders using all orders data\n  //affected orders = order.startTime >= thisOrder.endtime && in the same line && with the same date.\n  const affectedOrders = allData.filter(order => order.startTime >= _order.endTime && order.production_line === _order.production_line && order.order_date === _order.order_date)\n  \n  //work out thisOrder's total duration, which = its duration + its changeover duration\n  const deletingOrderDurationHour = moment.duration(_order.order_qty / _order.planned_rate, 'hours') \n  const deletingOrderChangeover = moment.duration(_order.planned_changeover_time, 'H:mm:ss')\n  const deletingOrderTotalDur = deletingOrderDurationHour.add(deletingOrderChangeover)\n  \n  //loop affected orders, order's starttime and endtime should both subtract the total duration worked out\n  affectedOrders.forEach(order => {\n    const line = influx.writeLineForTimeUpdate(order, deletingOrderTotalDur, 'subtract')\n    promises.push(utils.post(influx.writeUrl, line))\n  })\n\n  Promise.all(promises).then(() => {\n    utils.alert('success', 'Success', 'Order has been marked as Deleted')\n    closeForm()\n    chart.refreshDashboard()\n  }).catch(e => {\n    utils.alert('error', 'Database Error', 'An error occurred while deleting the order : ' + e)\n    closeForm()\n  })\n}"]}
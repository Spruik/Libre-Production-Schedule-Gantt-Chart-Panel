{"version":3,"sources":["../src/order_actions_ctrl.js"],"names":["showOrderActions","order","_order","status","cons","STATE_PLAN","STATE_READY","utils","alert","showModal","removeListeners","addListeners","$","document","off","on","e","target","id","insertOrder","editOrder","closeForm","updateOrderStatus","STATE_DELETED","url","postgRestHost","result","sure","get","ok","_orderStates","data","insert_actions","showActions","error","edit_actions","getOrderStates","line","influx","writeLineForUpdate","toLowerCase","deleteCurrentAndUpdateAffectOrders","post","writeUrl","then","chart","refreshDashboard","catch","promises","allData","dp","getData","affectedOrders","filter","startTime","endTime","production_line","order_date","deletingOrderDurationHour","moment","duration","order_qty","planned_rate","deletingOrderChangeover","planned_changeover_time","deletingOrderTotalDur","add","forEach","writeLineForTimeUpdate","push","Promise","all","trigger"],"mappings":"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","file":"order_actions_ctrl.js","sourcesContent":["import * as utils from './utils';\r\nimport * as influx from './influx_helper';\r\nimport * as insert_actions from './insertion_actions_ctrl';\r\nimport * as edit_actions from './editing_actions_ctrl';\r\nimport * as dp from './data_processor';\r\nimport * as cons from './constans';\r\nimport moment from 'moment';\r\nimport * as chart from './chart_option';\r\n\r\nlet _order;\r\nlet _orderStates;\r\nconst closeForm = () =>\r\n  $('a#product-schedule-gantt-chart-order-actions-close-btn').trigger('click');\r\n\r\nexport function showOrderActions(order) {\r\n  //set the order passed in global\r\n  _order = order;\r\n\r\n  //check if the order is available for editing, only 'planned' and 'ready' can be edited by scheduler\r\n  if (order.status !== cons.STATE_PLAN && order.status !== cons.STATE_READY) {\r\n    utils.alert(\r\n      'warning',\r\n      'Warning',\r\n      'The order status is ' +\r\n        order.status +\r\n        ', so it is no longer available for editing'\r\n    );\r\n    return;\r\n  }\r\n\r\n  //pop up the actions form\r\n  utils.showModal('order_actions.html', {});\r\n\r\n  //set listeners\r\n  removeListeners();\r\n  addListeners();\r\n}\r\n\r\nfunction removeListeners() {\r\n  $(document).off(\r\n    'click',\r\n    'input[type=\"radio\"][name=\"product-schedule-gantt-chart-order-actions-radio\"]'\r\n  );\r\n}\r\n\r\nfunction addListeners() {\r\n  $(document).on(\r\n    'click',\r\n    'input[type=\"radio\"][name=\"product-schedule-gantt-chart-order-actions-radio\"]',\r\n    e => {\r\n      if (e.target.id === 'insert') {\r\n        insertOrder();\r\n      } else if (e.target.id === 'edit') {\r\n        editOrder();\r\n      } else if (e.target.id === 'release') {\r\n        if (_order.status === cons.STATE_READY) {\r\n          utils.alert('warning', 'Warning', 'Order has already been released');\r\n          closeForm();\r\n        } else {\r\n          updateOrderStatus(cons.STATE_READY);\r\n        }\r\n      } else if (e.target.id === 'delete') {\r\n        updateOrderStatus(cons.STATE_DELETED);\r\n      }\r\n    }\r\n  );\r\n}\r\n\r\nasync function insertOrder() {\r\n  const url = `${utils.postgRestHost}order_state`;\r\n  const result = await utils.sure(utils.get(url));\r\n  if (result.ok) {\r\n    _orderStates = result.data;\r\n    insert_actions.showActions(_order);\r\n  } else {\r\n    utils.alert(\r\n      'error',\r\n      'Error',\r\n      `Error occurred when getting the Order State Configuration due to ${result.error} please try again or contact the dev team`\r\n    );\r\n  }\r\n}\r\n\r\nasync function editOrder() {\r\n  const url = `${utils.postgRestHost}order_state`;\r\n  const result = await utils.sure(utils.get(url));\r\n  if (result.ok) {\r\n    _orderStates = result.data;\r\n    edit_actions.showActions(_order);\r\n  } else {\r\n    utils.alert(\r\n      'error',\r\n      'Error',\r\n      `Error occurred when getting the Order State Configuration due to ${result.error} please try again or contact the dev team`\r\n    );\r\n  }\r\n}\r\n\r\nexport function getOrderStates() {\r\n  return _orderStates;\r\n}\r\n\r\nfunction updateOrderStatus(status) {\r\n  const line = influx.writeLineForUpdate(status, _order);\r\n  if (status.toLowerCase() === 'deleted') {\r\n    deleteCurrentAndUpdateAffectOrders(line);\r\n  } else {\r\n    utils\r\n      .post(influx.writeUrl, line)\r\n      .then(res => {\r\n        utils.alert('success', 'Success', 'Order has been marked as ' + status);\r\n        closeForm();\r\n        chart.refreshDashboard();\r\n      })\r\n      .catch(e => {\r\n        utils.alert(\r\n          'error',\r\n          'Database Error',\r\n          'An error occurred while updating the order : ' + e\r\n        );\r\n        closeForm();\r\n      });\r\n  }\r\n}\r\n\r\nfunction deleteCurrentAndUpdateAffectOrders(line) {\r\n  //create promises array and put the 'delete current order request' into it first\r\n  let promises = [utils.post(influx.writeUrl, line)];\r\n\r\n  //get all orders data for further filtering\r\n  const allData = dp.getData();\r\n\r\n  //filter affected orders using all orders data\r\n  //affected orders = order.startTime >= thisOrder.endtime && in the same line && with the same date.\r\n  const affectedOrders = allData.filter(\r\n    order =>\r\n      order.startTime >= _order.endTime &&\r\n      order.production_line === _order.production_line &&\r\n      order.order_date === _order.order_date\r\n  );\r\n\r\n  //work out thisOrder's total duration, which = its duration + its changeover duration\r\n  const deletingOrderDurationHour = moment.duration(\r\n    _order.order_qty / (_order.planned_rate * 60),\r\n    'hours'\r\n  );\r\n  const deletingOrderChangeover = moment.duration(\r\n    _order.planned_changeover_time,\r\n    'H:mm:ss'\r\n  );\r\n  const deletingOrderTotalDur = deletingOrderDurationHour.add(\r\n    deletingOrderChangeover\r\n  );\r\n\r\n  //loop affected orders, order's starttime and endtime should both subtract the total duration worked out\r\n  affectedOrders.forEach(order => {\r\n    const line = influx.writeLineForTimeUpdate(\r\n      order,\r\n      deletingOrderTotalDur,\r\n      'subtract'\r\n    );\r\n    promises.push(utils.post(influx.writeUrl, line));\r\n  });\r\n\r\n  Promise.all(promises)\r\n    .then(() => {\r\n      utils.alert('success', 'Success', 'Order has been marked as Deleted');\r\n      closeForm();\r\n      chart.refreshDashboard();\r\n    })\r\n    .catch(e => {\r\n      utils.alert(\r\n        'error',\r\n        'Database Error',\r\n        'An error occurred while deleting the order : ' + e\r\n      );\r\n      closeForm();\r\n    });\r\n}\r\n"]}